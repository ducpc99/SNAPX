# base.yaml – Cấu hình chung cho S-NAPX (local + Kaggle)

run_name: "snapx_local_hybrid_TinyLlama"
task: next_activity

# -----------------------------
# Dataset (bắt buộc cho run_local_eval.py)
# -----------------------------
dataset:
  path: "datasets/S-NAP.csv"              # đã được symlink trong snapx.py
  split_file: "datasets/snap_train_val_test.pkl"
  case_id_col: "model_id"
  prefix_col: "prefix"
  label_col: "next"
  prefix_sep: ";"

# -----------------------------
# Tiền xử lý / lọc dữ liệu
# -----------------------------
data:
  drop_end: true          # bỏ các next = [END]/END/...
  invert_labels: false
  min_activities: 2
  load_limit: 20000       # đồng bộ với LOAD_LIMIT trong notebook

# -----------------------------
# Sequence-only (Markov ensemble)
# -----------------------------
sequence:
  enabled: true
  alpha: 0.5
  markov_order: 2
  min_count: 1

# -----------------------------
# Graph (DFG + Reasoner)
# -----------------------------
graph:
  enabled: true
  dfg:
    min_count: 1
    min_ratio: 0.0
  reasoner:
    hard_mask: true
    boost_factor: 0.5
    min_prob_keep: 0.0

# -----------------------------
# Semantics (LLM)
# -----------------------------
semantics:
  use_llm: true                           # sẽ bị override thành False trong kaggle_seq_only.yaml
  model_name: "TinyLlama/TinyLlama-1.1B-Chat-v1.0"
  device: "auto"                          # để Kaggle tự chọn GPU nếu có
  load_in_4bit: true
  max_seq_len: 128
  mode: "logprob"
  gen:
    max_new_tokens: 16
    temperature: 0.0
    top_p: 1.0
    do_sample: false

# -----------------------------
# Semantics Prior
# -----------------------------
semantics_prior:
  enabled: true
  mode: "activity"
  default_weight: 1.0
  lambda_mix: 0.2
  floor: 0.7
  ceil: 1.3
  prior_map_path: null

# -----------------------------
# Guard
# -----------------------------
guard:
  enabled: true
  mode: "soft"
  use_activity_guard: true
  use_trace_guard: false
  penalty_factor: 0.5
  min_prefix_len: 1
  activity_dataset: null
  trace_dataset: null

# -----------------------------
# Hybrid controller
# -----------------------------
hybrid:
  top_k: 5
  enable_graph_reasoner: true
  enable_semantics_prior: true
  enable_guard: true
  enable_explanation: true

# -----------------------------
# Eval config
# -----------------------------
eval:
  num_samples: 50
  ndcg_k: 5
  measure_cost: true

# -----------------------------
# Paths
# -----------------------------
paths:
  output_dir: "outputs"
